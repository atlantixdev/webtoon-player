<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webtoon Creator and Player</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
        #creator-panel { width: 350px; padding: 20px; border-right: 1px solid #ccc; overflow-y: auto; background: #f9f9f9;}
        #player-panel { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #f0f0f0; }
        #player-image { max-width: 100%; max-height: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .panel-item { display: flex; align-items: center; margin-bottom: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; background: white;}
        .panel-item img { width: 50px; height: 50px; margin-right: 10px; object-fit: cover; border-radius: 4px;}
        .panel-controls { display: flex; flex-direction: column; gap: 5px; width: 100%;}
        .nav-buttons { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10;}
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        .progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: #ccc; }
        .progress { height: 100%; background: #007bff; width: 0%;}
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .word-balloon { position: absolute; background: white; border-radius: 20px; padding: 10px 15px; border: 2px solid black; font-family: 'Bangers', cursive; box-shadow: 3px 3px 5px rgba(0,0,0,0.2); }
        #my-webtoons-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100;}
        #my-webtoons-modal > div { background: white; padding: 20px; border-radius: 5px; width: 400px; max-height: 80%; overflow-y: auto;}
        #webtoon-projects-list li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #eee;}
        #webtoon-projects-list button { margin-left: 5px; background: #6c757d; font-size: 0.8em; padding: 4px 8px;}
        #webtoon-projects-list button.delete-btn { background: #dc3545;}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
</head>
<body>

    <div id="creator-panel">
        <h2>Webtoon Creator</h2>
        <button id="new-project-btn">New Project</button>
        <button id="my-webtoons-btn">My Webtoons</button>
        <hr>
        <input type="text" id="webtoon-title" placeholder="Webtoon Title" style="width: 95%; padding: 8px; margin-bottom: 10px;">
        <input type="file" id="image-upload" multiple accept="image/*" style="margin-bottom: 10px;">
        <div id="panel-list"></div>
        <button id="save-webtoon-btn" style="width: 100%; margin-top: 10px;">Save Webtoon</button>
        <div id="embed-code-container" style="display:none; margin-top: 15px;">
            <h3>Embed Code</h3>
            <textarea id="embed-code" readonly rows="4" style="width:95%; background:#eee;"></textarea>
        </div>
    </div>

    <div id="player-panel">
        <img id="player-image" src="" alt="Webtoon Panel">
        <canvas id="effects-canvas"></canvas>
        <div id="balloons-container"></div>
        <div class="nav-buttons">
            <button id="prev-btn">Previous</button>
            <button id="next-btn">Next</button>
        </div>
        <div class="progress-bar">
            <div id="progress" class="progress"></div>
        </div>
    </div>

    <div id="my-webtoons-modal">
        <div>
            <h3>My Webtoons</h3>
            <ul id="webtoon-projects-list" style="list-style: none; padding: 0;"></ul>
            <button id="close-modal-btn" style="margin-top: 10px;">Close</button>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD01LV0sf0wgkzEeFov6IPOYKnVEitcnTM",
          authDomain: "n-webtoon-player.firebaseapp.com",
          projectId: "n-webtoon-player",
          storageBucket: "n-webtoon-player.firebasestorage.app",
          messagingSenderId: "1040378436513",
          appId: "1:1040378436513:web:4320ebcef0c0a727f949e0",
          measurementId: "G-FSZSE5TMRF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // All the application logic will go here.
        // --- App State ---
        let panels = [];
        let currentPanelIndex = 0;
        let currentBalloonIndex = -1;
        let currentProjectId = null;

        // --- DOM Elements ---
        const creatorPanel = document.getElementById('creator-panel');
        const playerPanel = document.getElementById('player-panel');
        const imageUpload = document.getElementById('image-upload');
        const panelList = document.getElementById('panel-list');
        const playerImage = document.getElementById('player-image');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progress = document.getElementById('progress');
        const effectsCanvas = document.getElementById('effects-canvas');
        const ctx = effectsCanvas.getContext('2d');
        const saveWebtoonBtn = document.getElementById('save-webtoon-btn');
        const embedCodeContainer = document.getElementById('embed-code-container');
        const embedCode = document.getElementById('embed-code');
        const webtoonTitle = document.getElementById('webtoon-title');
        const balloonsContainer = document.getElementById('balloons-container');
        const newProjectBtn = document.getElementById('new-project-btn');
        const myWebtoonsBtn = document.getElementById('my-webtoons-btn');
        const myWebtoonsModal = document.getElementById('my-webtoons-modal');
        const webtoonProjectsList = document.getElementById('webtoon-projects-list');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // Check for player mode from URL
        const urlParams = new URLSearchParams(window.location.search);
        const webtoonId = urlParams.get('webtoonId');
        if (webtoonId) {
            creatorPanel.style.display = 'none';
            playerPanel.style.width = '100%';
            loadWebtoonForPlayer(webtoonId);
        }

        // --- Creator Logic ---
        imageUpload.addEventListener('change', (e) => {
            for (const file of e.target.files) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    panels.push({
                        src: event.target.result,
                        visualEffect: 'none',
                        audioEffect: 'none',
                        balloons: []
                    });
                    renderPanelList();
                };
                reader.readAsDataURL(file);
            }
        });

        function renderPanelList() {
            panelList.innerHTML = '';
            panels.forEach((panel, index) => {
                const item = document.createElement('div');
                item.className = 'panel-item';
                item.dataset.index = index;

                item.innerHTML = `
                    <img src="${panel.src}" alt="Panel ${index + 1}">
                    <div class="panel-controls">
                        <select class="visual-effect">
                            <option value="none">No Visual Effect</option>
                            <option value="rain">Rain</option>
                            <option value="snow">Snow</option>
                        </select>
                        <select class="audio-effect">
                            <option value="none">No Audio Effect</option>
                            <option value="beep">Beep</option>
                        </select>
                        <button class="add-balloon-btn">Add Balloon</button>
                        <div class="balloons-list"></div>
                    </div>
                `;

                item.querySelector('.visual-effect').value = panel.visualEffect;
                item.querySelector('.audio-effect').value = panel.audioEffect;

                item.querySelector('.visual-effect').addEventListener('change', (e) => panels[index].visualEffect = e.target.value);
                item.querySelector('.audio-effect').addEventListener('change', (e) => panels[index].audioEffect = e.target.value);
                item.querySelector('.add-balloon-btn').addEventListener('click', () => {
                    panels[index].balloons.push({ text: 'New Text', style: 'speech', x: 50, y: 50 });
                    renderPanelList();
                });

                const balloonsList = item.querySelector('.balloons-list');
                panel.balloons.forEach((balloon