<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Webtoon Creator & Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bangers&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .comic-font { font-family: 'Bangers', cursive; }
        .draggable-ghost { opacity: 0.5; background: #4f46e5; }
        .panel-item:hover .drag-handle { opacity: 1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .thumbnail-container { position: relative; width: 3rem; height: 4rem; flex-shrink: 0; }
        .thumbnail-icon { position: absolute; bottom: 2px; right: 2px; background-color: rgba(0,0,0,0.6); border-radius: 9999px; padding: 2px; }
        #progress-bar { transition: width 0.3s ease-in-out; }
        .word-balloon { position: absolute; padding: 12px 18px; background: white; color: black; border-radius: 20px; max-width: 40%; word-wrap: break-word; border: 3px solid black; line-height: 1.3; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4)); transform: translate(-50%, -50%); z-index: 10; pointer-events: none; }
        .word-balloon.thought { border-style: dashed; border-radius: 50%; }
        .word-balloon.shout { border-radius: 0; clip-path: polygon(0% 15%, 15% 15%, 15% 0%, 30% 15%, 45% 0%, 60% 15%, 75% 0%, 85% 15%, 100% 15%, 100% 85%, 85% 85%, 75% 100%, 60% 85%, 45% 100%, 30% 85%, 15% 100%, 15% 85%, 0% 85%); }
        .balloon-tail-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9; }
        .balloon-tail { fill: white; stroke: black; stroke-width: 0.75; }
        .balloon-edit-modal-preview { position: relative; width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .draggable-balloon, .tail-handle { position: absolute; cursor: grab; z-index: 11; pointer-events: auto; }
        .draggable-balloon:active, .tail-handle:active { cursor: grabbing; }
        .tail-handle { width: 12px; height: 12px; background-color: #4f46e5; border-radius: 50%; border: 2px solid white; transform: translate(-50%, -50%); }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app-container" class="flex flex-col md:flex-row h-screen w-screen overflow-hidden">
        <div id="creator-panel" class="w-full md:w-1/3 bg-gray-800 p-6 flex flex-col space-y-4 overflow-y-auto no-scrollbar">
            <header class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-400">Webtoon Creator</h1>
                <div class="flex space-x-2">
                    <button id="new-project-btn" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-lg">New Project</button>
                    <button id="my-webtoons-btn" class="text-xs bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded-lg">My Webtoons</button>
                </div>
            </header>
            <div class="flex items-center space-x-2">
                 <input type="text" id="webtoon-title" placeholder="Enter Webtoon Title" class="flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                 <span id="user-id-display" class="text-xs text-gray-500 p-2 bg-gray-700 rounded-md"></span>
            </div>
            <div>
                <label for="media-upload" class="w-full inline-block bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg cursor-pointer hover:bg-indigo-700 transition-colors text-center">
                    Upload Media (Images/Videos)
                </label>
                <input type="file" id="media-upload" multiple accept="image/*,video/mp4,video/webm" class="hidden">
            </div>
            <div id="panel-list" class="flex-grow space-y-3 pr-2 overflow-y-auto">
                <div id="placeholder-message" class="text-center text-gray-500 p-8 border-2 border-dashed border-gray-700 rounded-lg">
                   <p>Uploaded panels will appear here.</p>
               </div>
            </div>
            <div class="flex-shrink-0 space-y-2 pt-4 border-t border-gray-700">
                 <button id="save-webtoon" class="w-full bg-green-600 font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" /></svg>
                    <span>Save Webtoon</span>
                </button>
                 <div id="embed-code-area" class="hidden">
                    <label class="text-sm font-medium text-gray-300">Embed Code:</label>
                    <textarea id="embed-code" readonly class="w-full bg-gray-900 text-indigo-300 p-2 rounded-lg text-xs font-mono no-scrollbar" rows="3"></textarea>
                    <button id="copy-embed-code" class="w-full mt-1 bg-gray-600 text-xs font-semibold py-1 px-2 rounded-lg hover:bg-gray-500 transition-colors">Copy Code</button>
                </div>
                 <button id="export-html-btn" class="w-full mt-2 bg-blue-600 font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    <span>Export as HTML File</span>
                 </button>
            </div>
             <div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
            </div>
             <div id="message-box" class="hidden fixed bottom-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg max-w-sm"></div>
        </div>
        <div id="player-panel" class="w-full md:w-2/3 h-full bg-gray-900 relative flex flex-col items-center justify-center">
            <div id="player-container" class="relative w-full h-full max-w-2xl mx-auto flex items-center justify-center">
                <img id="panel-image" src="https://placehold.co/800x1200/111827/4f46e5?text=Webtoon+Player" alt="Webtoon Panel" class="max-w-full max-h-full object-contain rounded-lg block">
                <video id="panel-video" src="" alt="Webtoon Panel" class="max-w-full max-h-full object-contain rounded-lg hidden" autoplay muted loop playsinline></video>
                <div id="balloons-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10"></div>
            </div>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center items-center space-x-4">
                <button id="prev-panel" class="bg-gray-800/50 backdrop-blur-sm p-3 rounded-full hover:bg-indigo-500/80 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                 <div class="flex-grow max-w-xs">
                    <div class="w-full bg-gray-700/50 rounded-full h-1.5">
                        <div id="progress-bar" class="bg-indigo-500 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <button id="next-panel" class="bg-gray-800/50 backdrop-blur-sm p-3 rounded-full hover:bg-indigo-500/80 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="balloon-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="w-full h-full flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <div class="md:w-2/3 h-1/2 md:h-full bg-gray-800 rounded-lg relative overflow-hidden balloon-edit-modal-preview"></div>
            <div class="md:w-1/3 h-1/2 md:h-full bg-gray-800 rounded-lg p-4 flex flex-col">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">Edit Balloons</h2>
                <div id="balloon-modal-controls" class="flex-grow overflow-y-auto no-scrollbar space-y-3"></div>
                <div class="mt-4 flex-shrink-0">
                    <button id="add-balloon-in-modal" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg mb-2">+ Add New Balloon</button>
                    <button id="close-balloon-modal" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Done</button>
                </div>
            </div>
        </div>
    </div>
    <div id="my-webtoons-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg">
            <h2 class="text-xl font-bold text-indigo-400 mb-4">My Webtoons</h2>
            <div id="my-webtoons-list" class="max-h-96 overflow-y-auto no-scrollbar space-y-2"></div>
            <button id="close-my-webtoons" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Close</button>
        </div>
    </div>
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="p-6 bg-red-800 border-2 border-red-600 rounded-lg text-white max-w-lg w-full">
            <h2 class="font-bold text-xl mb-2">Configuration Error</h2>
            <p id="error-message" class="text-base"></p>
            <div id="error-steps"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        main();

        function main() {
            const firebaseConfig = { apiKey: "AIzaSyD01LV0sf0wgkzEeFov6IPOYKnVEitcnTM", authDomain: "n-webtoon-player.firebaseapp.com", projectId: "n-webtoon-player", storageBucket: "n-webtoon-player.appspot.com", messagingSenderId: "1040378436513", appId: "1:1040378436513:web:4320ebcef0c0a727f949e0" };
            const state = { isAuthReady: false, db: null, auth: null, userId: null, webtoonId: null, webtoonData: { title: 'Untitled Webtoon', creatorId: null, panels: [] }, currentPanel: 0, currentBalloonIndex: -1, activeEditPanelId: null };
            const ui = { mediaUpload: document.getElementById('media-upload'), panelList: document.getElementById('panel-list'), placeholder: document.getElementById('placeholder-message'), loadingIndicator: document.getElementById('loading-indicator'), panelImage: document.getElementById('panel-image'), panelVideo: document.getElementById('panel-video'), balloonsContainer: document.getElementById('balloons-container'), prevButton: document.getElementById('prev-panel'), nextButton: document.getElementById('next-panel'), progressBar: document.getElementById('progress-bar'), balloonEditModal: document.getElementById('balloon-edit-modal'), balloonModalPreview: document.querySelector('.balloon-edit-modal-preview'), balloonModalControls: document.getElementById('balloon-modal-controls'), closeBalloonModal: document.getElementById('close-balloon-modal'), addBalloonInModal: document.getElementById('add-balloon-in-modal'), webtoonTitle: document.getElementById('webtoon-title'), saveButton: document.getElementById('save-webtoon'), newProjectBtn: document.getElementById('new-project-btn'), myWebtoonsBtn: document.getElementById('my-webtoons-btn'), myWebtoonsModal: document.getElementById('my-webtoons-modal'), myWebtoonsList: document.getElementById('my-webtoons-list'), closeMyWebtoons: document.getElementById('close-my-webtoons'), userIdDisplay: document.getElementById('user-id-display'), embedCodeArea: document.getElementById('embed-code-area'), embedCode: document.getElementById('embed-code'), copyEmbedCode: document.getElementById('copy-embed-code'), exportHtmlBtn: document.getElementById('export-html-btn'), errorModal: document.getElementById('error-modal'), errorMessage: document.getElementById('error-message'), errorSteps: document.getElementById('error-steps') };
            let panelCounter = 0;

            function showLoading(isLoading) { if(ui.loadingIndicator) ui.loadingIndicator.classList.toggle('hidden', !isLoading); }
            
            function createPanelElement(panel) {
                const el = document.createElement('div');
                el.className = 'panel-item bg-gray-700 p-2 rounded-lg flex items-center space-x-3';
                el.dataset.id = panel.id;
                el.setAttribute('draggable', 'true');

                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle text-gray-500 hover:text-white transition-colors p-1';
                dragHandle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                el.appendChild(dragHandle);

                const thumbContainer = document.createElement('div');
                thumbContainer.className = 'thumbnail-container';
                const thumbImg = document.createElement('img');
                thumbImg.className = 'w-16 h-20 object-cover rounded-md';
                thumbImg.src = panel.thumbnailData || panel.mediaData;
                thumbContainer.appendChild(thumbImg);
                
                if (panel.type === 'video') {
                    const videoIcon = document.createElement('div');
                    videoIcon.className = 'thumbnail-icon';
                    videoIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 001.553.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>`;
                    thumbContainer.appendChild(videoIcon);
                }
                el.appendChild(thumbContainer);

                const infoContainer = document.createElement('div');
                infoContainer.className = 'flex-grow flex flex-col space-y-2';
                const panelTitle = document.createElement('span');
                panelTitle.className = 'text-sm text-gray-300';
                panelTitle.textContent = `Panel #${panel.index}`;
                infoContainer.appendChild(panelTitle);

                const editBtn = document.createElement('button');
                editBtn.className = 'text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-2 rounded-md self-start';
                editBtn.textContent = 'Edit Balloons';
                editBtn.addEventListener('click', () => openBalloonEditor(panel.id));
                infoContainer.appendChild(editBtn);
                
                el.appendChild(infoContainer);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-gray-500 hover:text-red-500 p-1';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
                
                deleteBtn.addEventListener('click', () => {
                    state.webtoonData.panels = state.webtoonData.panels.filter(p => p.id !== panel.id);
                    renderPanelList();
                    updatePlayer();
                });
                el.appendChild(deleteBtn);

                return el;
            }

            function renderPanelList() {
                ui.panelList.innerHTML = '';
                if (state.webtoonData.panels.length === 0) {
                    ui.panelList.appendChild(ui.placeholder);
                } else {
                    state.webtoonData.panels.forEach(panel => {
                        const panelEl = createPanelElement(panel);
                        ui.panelList.appendChild(panelEl);
                    });
                }
            }

            async function handleFileUpload(event) {
                const files = Array.from(event.target.files);
                if (!files || files.length === 0) return;
                ui.loadingIndicator.classList.remove('hidden');

                for (const file of files) {
                    try {
                        const panelData = await processFile(file);
                        state.webtoonData.panels.push(panelData);
                    } catch (error) {
                        console.error("Error processing file:", error);
                    }
                }
                
                renderPanelList();
                updatePlayer();
                ui.loadingIndicator.classList.add('hidden');
                event.target.value = '';
            }
            
            function processFile(file) {
                 return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const panelData = { id: crypto.randomUUID(), mediaData: e.target.result, type: file.type.startsWith('video') ? 'video' : 'image', thumbnailData: null, index: ++panelCounter, balloons: [] };
                        if (panelData.type === 'video') {
                            const video = document.createElement('video');
                            video.preload = 'metadata';
                            video.muted = true;
                            video.playsInline = true;
                            video.addEventListener('loadeddata', () => video.currentTime = 1);
                            video.addEventListener('seeked', () => { const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height); panelData.thumbnailData = canvas.toDataURL('image/jpeg'); resolve(panelData); });
                            video.addEventListener('error', (err) => reject(new Error('Video file could not be loaded.')));
                            video.src = e.target.result;
                        } else {
                            resolve(panelData);
                        }
                    };
                    reader.onerror = (err) => reject(new Error('File could not be read.'));
                    reader.readAsDataURL(file);
                });
            }
            
            function updateBalloons() {
                const panel = state.webtoonData.panels[state.currentPanel];
                ui.balloonsContainer.innerHTML = '';
                if (!panel || !panel.balloons) return;

                panel.balloons.slice(0, state.currentBalloonIndex + 1).forEach(balloon => {
                    const balloonEl = document.createElement('div');
                    balloonEl.className = `word-balloon comic-font ${balloon.style}`;
                    balloonEl.textContent = balloon.text;
                    balloonEl.style.fontSize = `${balloon.fontSize || 1.2}rem`;
                    balloonEl.style.left = `${balloon.position.x}%`;
                    balloonEl.style.top = `${balloon.position.y}%`;
                    ui.balloonsContainer.appendChild(balloonEl);

                    if (balloon.style === 'speech' && balloon.tail) {
                        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        svg.setAttribute('class', 'balloon-tail-svg');
                        svg.setAttribute('viewBox', '0 0 100 100');
                        svg.setAttribute('preserveAspectRatio', 'none');
                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const p = balloon.position;
                        const t = balloon.tail.tip;
                        const b1 = balloon.tail.base;
                        const angle = Math.atan2(b1.y - p.y, b1.x - p.x);
                        const width = 3;
                        path.setAttribute('d', `M ${b1.x - width * Math.sin(angle)},${b1.y + width * Math.cos(angle)} L ${t.x},${t.y} L ${b1.x + width * Math.sin(angle)},${b1.y - width * Math.cos(angle)} Z`);
                        path.setAttribute('class', 'balloon-tail');
                        svg.appendChild(path);
                        ui.balloonsContainer.appendChild(svg);
                    }
                });
            }

            function updatePlayer(isNewPanel = true) {
                if (state.webtoonData.panels.length === 0) {
                    ui.panelImage.src = 'https://placehold.co/800x1200/111827/4f46e5?text=Webtoon+Player';
                    ui.panelImage.classList.remove('hidden');
                    ui.panelVideo.classList.add('hidden');
                    ui.progressBar.style.width = '0%';
                    return;
                }
                const panel = state.webtoonData.panels[state.currentPanel];
                if (!panel) return;

                if(isNewPanel) {
                    const mediaEl = panel.type === 'video' ? ui.panelVideo : ui.panelImage;
                    const otherEl = panel.type === 'video' ? ui.panelImage : ui.panelVideo;
                    otherEl.classList.add('hidden');
                    mediaEl.src = panel.mediaData;
                    mediaEl.classList.remove('hidden');
                }
                
                updateBalloons();

                const progress = ((state.currentPanel + 1) / state.webtoonData.panels.length) * 100;
                ui.progressBar.style.width = `${progress}%`;
            }
            
            async function nextPanel() { const panel = state.webtoonData.panels[state.currentPanel]; if (!panel) return; const maxSteps = (panel.balloons?.length || 0); if (state.currentBalloonIndex < maxSteps -1) { state.currentBalloonIndex++; updatePlayer(false); } else { if(state.currentPanel < state.webtoonData.panels.length - 1){ state.currentPanel++; state.currentBalloonIndex = -1; updatePlayer(true); } } }
            async function prevPanel() { if(state.currentBalloonIndex > 0) { state.currentBalloonIndex--; updatePlayer(false); } else { if (state.currentPanel > 0) { state.currentPanel--; const prevPanel = state.webtoonData.panels[state.currentPanel]; state.currentBalloonIndex = (prevPanel.balloons?.length || 0) -1; updatePlayer(true); } } }
            
            function openBalloonEditor(panelId) { state.activeEditPanelId = panelId; const panel = state.webtoonData.panels.find(p => p.id === panelId); if(!panel) return; if(panel.type === 'image') { ui.balloonModalPreview.style.backgroundImage = `url(${panel.mediaData})`; } else if (panel.thumbnailData) { ui.balloonModalPreview.style.backgroundImage = `url(${panel.thumbnailData})`; } else { ui.balloonModalPreview.style.backgroundImage = ''; ui.balloonModalPreview.style.backgroundColor = '#1f2937'; } renderBalloonControlsInModal(); renderBalloonsInModal(); ui.balloonEditModal.classList.remove('hidden'); }
            function renderBalloonControlsInModal() { const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); if(!panel) return; ui.balloonModalControls.innerHTML = ''; (panel.balloons || []).forEach(balloon => { const controlEl = document.createElement('div'); controlEl.className = 'bg-gray-900 p-3 rounded-md space-y-2'; controlEl.dataset.balloonId = balloon.id; controlEl.innerHTML = `<textarea data-control="text" class="w-full bg-gray-700 text-sm rounded p-1" rows="2" placeholder="Balloon text...">${balloon.text}</textarea><div class="flex space-x-2"><select data-control="style" class="flex-grow bg-gray-700 text-xs rounded p-1"><option value="speech">Speech</option><option value="thought">Thought</option><option value="shout">Shout</option></select><button data-action="remove-balloon" class="text-gray-500 hover:text-red-500 p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div><div><label class="text-xs text-gray-400">Font Size</label><input data-control="fontSize" type="range" min="0.8" max="2.5" step="0.1" value="${balloon.fontSize || 1.2}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"></div>`; controlEl.querySelector('select').value = balloon.style; ui.balloonModalControls.appendChild(controlEl); }); }
            function renderBalloonsInModal() { const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); if(!panel) return; ui.balloonModalPreview.innerHTML = ''; (panel.balloons || []).forEach(b => { const d = document.createElement('div'); d.className=`word-balloon comic-font draggable-balloon ${b.style}`; d.textContent=b.text; d.dataset.balloonId = b.id; d.style.fontSize = `${b.fontSize || 1.2}rem`; d.style.left=`${b.position.x}%`; d.style.top=`${b.position.y}%`; ui.balloonModalPreview.appendChild(d); if (b.style === 'speech' && b.tail) { const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); svg.setAttribute('class', 'balloon-tail-svg'); svg.setAttribute('viewBox', '0 0 100 100'); svg.setAttribute('preserveAspectRatio', 'none'); const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); const p = b.position; const t = b.tail.tip; const b1 = b.tail.base; const angle = Math.atan2(b1.y - p.y, b1.x - p.x); const width = 3; path.setAttribute('d', `M ${b1.x - width * Math.sin(angle)},${b1.y + width * Math.cos(angle)} L ${t.x},${t.y} L ${b1.x + width * Math.sin(angle)},${b1.y - width * Math.cos(angle)} Z`); path.setAttribute('class', 'balloon-tail'); svg.appendChild(path); ui.balloonModalPreview.appendChild(svg); const tipHandle = document.createElement('div'); tipHandle.className = 'tail-handle'; tipHandle.dataset.handleType = 'tip'; tipHandle.dataset.balloonId = b.id; tipHandle.style.left = `${b.tail.tip.x}%`; tipHandle.style.top = `${b.tail.tip.y}%`; ui.balloonModalPreview.appendChild(tipHandle); const baseHandle = document.createElement('div'); baseHandle.className = 'tail-handle'; baseHandle.dataset.handleType = 'base'; baseHandle.dataset.balloonId = b.id; baseHandle.style.left = `${b.tail.base.x}%`; baseHandle.style.top = `${b.tail.base.y}%`; ui.balloonModalPreview.appendChild(baseHandle); } }); }
            
            function setupEventListeners() {
                ui.mediaUpload.addEventListener('change', handleFileUpload);
                ui.nextButton.addEventListener('click', nextPanel);
                ui.prevButton.addEventListener('click', prevPanel);
                let draggedItem = null;
                ui.panelList.addEventListener('dragstart', (e) => { draggedItem = e.target.closest('.panel-item'); if(draggedItem){ setTimeout(() => { if (draggedItem) draggedItem.classList.add('draggable-ghost'); }, 0); }});
                ui.panelList.addEventListener('dragend', () => { if (draggedItem) { draggedItem.classList.remove('draggable-ghost'); const newPanelOrderIds = Array.from(ui.panelList.children).map(el => el.dataset ? el.dataset.id : null).filter(id => id); state.webtoonData.panels.sort((a, b) => newPanelOrderIds.indexOf(a.id) - newPanelOrderIds.indexOf(b.id)); draggedItem = null; }});
                ui.panelList.addEventListener('dragover', (e) => { e.preventDefault(); const overItem = e.target.closest('.panel-item'); if (overItem && draggedItem && overItem !== draggedItem) { const rect = overItem.getBoundingClientRect(); const next = (e.clientY - rect.top - (rect.height / 2)) > 0; if (next) ui.panelList.insertBefore(draggedItem, overItem.nextSibling); else ui.panelList.insertBefore(draggedItem, overItem); }});
                
                ui.closeBalloonModal.addEventListener('click', () => { ui.balloonEditModal.classList.add('hidden'); renderPanelList(); });
                ui.addBalloonInModal.addEventListener('click', () => { const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); if(panel) { panel.balloons.push({ id: crypto.randomUUID(), text: 'New balloon...', style: 'speech', fontSize: 1.2, position: { x: 50, y: 50 }, tail: { base: {x: 40, y: 65}, tip: {x: 50, y: 85} } }); renderBalloonControlsInModal(); renderBalloonsInModal(); } });
                ui.balloonModalControls.addEventListener('click', e => { const removeBtn = e.target.closest('button[data-action="remove-balloon"]'); if(removeBtn) { const controlEl = removeBtn.closest('[data-balloon-id]'); const balloonId = controlEl.dataset.balloonId; const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); if(panel) { panel.balloons = panel.balloons.filter(b => b.id !== balloonId); renderBalloonControlsInModal(); renderBalloonsInModal(); } } });
                ui.balloonModalControls.addEventListener('input', e => { const target = e.target; const controlEl = target.closest('[data-balloon-id]'); if(!controlEl) return; const balloonId = controlEl.dataset.balloonId; const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); const balloon = panel.balloons.find(b => b.id === balloonId); if(!balloon) return; if(target.matches('[data-control="text"]')) { balloon.text = target.value; } else if (target.matches('[data-control="style"]')) { balloon.style = target.value; } else if (target.matches('[data-control="fontSize"]')) { balloon.fontSize = parseFloat(target.value); } renderBalloonsInModal(); });
                let draggedEl = { el: null, type: null, balloonId: null }; ui.balloonModalPreview.addEventListener('mousedown', e => { const target = e.target.closest('.draggable-balloon, .tail-handle'); if(target) { draggedEl.el = target; draggedEl.balloonId = target.dataset.balloonId; draggedEl.type = target.classList.contains('draggable-balloon') ? 'balloon' : 'tail'; if(draggedEl.type === 'tail') draggedEl.handleType = target.dataset.handleType; target.style.cursor = 'grabbing'; document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd); } }); function onDragMove(e) { if (!draggedEl.el) return; const rect = ui.balloonModalPreview.getBoundingClientRect(); let xPercent = ((e.clientX - rect.left) / rect.width) * 100; let yPercent = ((e.clientY - rect.top) / rect.height) * 100; xPercent = Math.max(0, Math.min(xPercent, 100)); yPercent = Math.max(0, Math.min(yPercent, 100)); draggedEl.el.style.left = `${xPercent}%`; draggedEl.el.style.top = `${yPercent}%`; const panel = state.webtoonData.panels.find(p => p.id === state.activeEditPanelId); const balloon = panel.balloons.find(b => b.id === draggedEl.balloonId); if(!balloon) return; if(draggedEl.type === 'balloon') { balloon.position = {x: xPercent, y: yPercent}; } else { balloon.tail[draggedEl.handleType] = {x: xPercent, y: yPercent}; } renderBalloonsInModal(); } function onDragEnd() { if (!draggedEl.el) return; draggedEl.el.style.cursor = 'grab'; draggedEl = { el: null, type: null, balloonId: null }; document.removeEventListener('mousemove', onDragMove); document.removeEventListener('mouseup', onDragEnd); }
            }
            
            init();
            
            async function init() { 
                setupEventListeners();
                window.addEventListener('resize', () => { if(ui.effectsCanvas && ui.playerContainer) { ui.effectsCanvas.width = ui.playerContainer.clientWidth; ui.effectsCanvas.height = ui.playerContainer.clientHeight; }});
                try { if(Tone) { synth = new Tone.Synth().toDestination(); const filter = new Tone.AutoFilter({ frequency: "8n", baseFrequency: 150, octaves: 4 }).toDestination(); roarSynth = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.2, decay: 1.5, sustain: 0, release: 2 } }).connect(filter); const dist = new Tone.Distortion(0.6).toDestination(); fierceRoarSynth = new Tone.NoiseSynth({noise: {type: 'pink'}, envelope: {attack: 0.01, decay: 0.8, sustain: 0.1, release: 1.5}}).connect(dist); rainSynth = new Tone.NoiseSynth({noise: {type:'white'}, volume: -20, envelope: {attack: 0.5}}).toDestination(); rainSynth.volume.value = -Infinity; } } catch(e) { console.warn("Audio context could not be started."); } 
                const urlParams = new URLSearchParams(window.location.search);
                const viewMode = urlParams.get('view');
                const webtoonToLoad = urlParams.get('id');
                
                if (viewMode === 'player' && webtoonToLoad) { 
                    const creatorPanel = document.getElementById('creator-panel');
                    if (creatorPanel) creatorPanel.style.display = 'none';
                    document.getElementById('player-panel').style.width = '100%';
                }
                
                if (!firebaseConfig.apiKey) return showErrorModal('Firebase is not configured.', '<p class="text-sm">Please add your firebaseConfig object to the code.</p>');
                try {
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);
                    const userCredential = await signInAnonymously(state.auth);
                    state.userId = userCredential.user.uid;
                    ui.userIdDisplay.textContent = `User ID: ${state.userId.substring(0, 8)}...`;
                    state.isAuthReady = true;
                    
                    if (viewMode === 'player' && webtoonToLoad) {
                        loadWebtoon(webtoonToLoad, true);
                    } else {
                        renderPanelList(); 
                    }
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    if (error.code === 'auth/configuration-not-found') showErrorModal("Anonymous sign-in not enabled.", `<p class="text-sm mt-3 font-semibold">To fix this:</p><ol class="list-decimal list-inside text-sm mt-1 space-y-1"><li>Go to the <a href="https://console.firebase.google.com/" target="_blank" class="underline hover:text-indigo-300">Firebase Console</a>.</li><li>Select your project (<strong>${firebaseConfig.projectId}</strong>).</li><li>Go to <strong>Build > Authentication > Sign-in method</strong>.</li><li>Enable the <strong>Anonymous</strong> provider.</li><li>Reload this page.</li></ol>`);
                    else if (error.code === 'auth/requests-from-referer-blocked') showErrorModal("API Key Restriction Active", `<p class="text-sm">This is a good sign! Your API key is secured. This preview environment is correctly blocked.</p><p class="text-sm mt-3 font-semibold">To test new changes:</p><ol class="list-decimal list-inside text-sm mt-1 space-y-1"><li>Upload this updated <strong>index.html</strong> file to your GitHub repository.</li><li>Test the changes on your live GitHub Pages URL: <a href="https://atlantixdev.github.io/webtoon-player/" target="_blank" class="underline hover:text-indigo-300">atlantixdev.github.io/webtoon-player/</a></li></ol>`);
                    else showErrorModal("Could not connect to services.", `<p class="text-sm">${error.message}</p>`);
                }
            }
        }
    </script>
</body>
</html>
